<!-- pages/settings/settings.wxml - ä¿®å¤ç‰ˆ -->
<view class="settings-page">
    <view wx:if="{{loading}}" class="loading-center">åŠ è½½ä¸­...</view>
    <view wx:else>
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="card user-card">
        <view class="user-avatar">
          <text class="user-emoji">{{isPatient ? 'ğŸŒ±' : 'ğŸ‘¨â€âš•ï¸'}}</text>
        </view>
        <view class="user-info">
          <text class="user-name">{{nickname || 'ç”¨æˆ·'}}</text>
          <!-- ä¿®å¤5ï¼šä¸ç”¨"æ‚£è€…"è¿™ç§æ¶ˆæè¯ -->
          <text class="user-role">{{isPatient ? 'è®°å½•æœ¬äºº' : 'å®¶å± / ç…§æŠ¤è€…'}}</text>
        </view>
      </view>

      <!-- å½“å‰ç–—ç¨‹ -->
      <view class="card">
        <text class="section-title">ğŸ’Š å½“å‰ç–—ç¨‹</text>
        <view wx:if="{{cycleNo > 0}}" class="cycle-info">
          <text class="cycle-text">ç¬¬{{cycleNo}}ç–—ç¨‹ Â· Day {{cycleDay}}</text>
          <text class="cycle-start">å¼€å§‹æ—¥æœŸ: {{startDate}} Â· å‘¨æœŸ{{lengthDays}}å¤©</text>
        </view>
        <text wx:else class="empty-hint">æš‚æ— ç–—ç¨‹</text>

        <!-- ç¼–è¾‘å½“å‰ç–—ç¨‹ -->
        <view wx:if="{{cycleNo > 0 && !showNewCycle}}">
          <view wx:if="{{!showEditCycle}}">
            <view class="cycle-actions">
              <view class="cycle-action-btn" bindtap="toggleEditCycle">
                <text>âœï¸ ä¿®æ”¹æ—¥æœŸ</text>
              </view>
              <view class="cycle-action-btn" bindtap="toggleNewCycle">
                <text>â• ä¸‹ä¸€ç–—ç¨‹</text>
              </view>
            </view>
          </view>
          <view wx:else class="edit-form">
            <view class="input-group">
              <text class="input-label">å¼€å§‹æ—¥æœŸ</text>
              <picker mode="date" value="{{editStartDate}}" bindchange="onEditStartDateChange">
                <view class="input-field picker-field">{{editStartDate || 'é€‰æ‹©æ—¥æœŸ'}}</view>
              </picker>
            </view>
            <view class="input-group">
              <text class="input-label">å‘¨æœŸå¤©æ•°</text>
              <input type="number" value="{{editLengthDays}}" bindinput="onEditLengthDaysInput" class="input-field" placeholder="21" />
            </view>
            <button class="btn-primary" bindtap="onSaveEditCycle">ä¿å­˜ä¿®æ”¹</button>
            <button class="btn-outline" bindtap="toggleEditCycle" style="margin-top: 12rpx;">å–æ¶ˆ</button>
          </view>
        </view>

        <!-- æ–°å»ºç–—ç¨‹ -->
        <view wx:if="{{cycleNo === 0 && !showNewCycle}}">
          <button class="btn-primary" bindtap="toggleNewCycle">+ åˆ›å»ºç–—ç¨‹</button>
        </view>
        <view wx:if="{{showNewCycle}}" class="edit-form">
          <view class="input-group">
            <text class="input-label">ç¬¬å‡ ç–—ç¨‹</text>
            <input type="number" value="{{newCycleNo}}" bindinput="onNewCycleNoInput" class="input-field" placeholder="ä¾‹å¦‚: 6" />
          </view>
          <view class="input-group">
            <text class="input-label">å¼€å§‹æ—¥æœŸ</text>
            <picker mode="date" value="{{newStartDate}}" bindchange="onNewStartDateChange">
              <view class="input-field picker-field">{{newStartDate || 'é€‰æ‹©æ—¥æœŸ'}}</view>
            </picker>
          </view>
          <button class="btn-primary" bindtap="onCreateCycle">åˆ›å»º</button>
          <button class="btn-outline" bindtap="toggleNewCycle" style="margin-top: 12rpx;">å–æ¶ˆ</button>
        </view>
      </view>

      <!-- å†å²ç–—ç¨‹ï¼ˆæ‰€æœ‰è§’è‰²å¯è§ï¼‰ -->
      <view class="card" wx:if="{{allCycles.length > 1}}">
        <view class="history-header" bindtap="toggleHistory">
          <text class="section-title">ğŸ“‚ å†å²ç–—ç¨‹</text>
          <text class="history-arrow {{showHistory ? 'open' : ''}}">â€º</text>
        </view>

        <view wx:if="{{showHistory}}" class="history-list">
          <view
            wx:for="{{allCycles}}" wx:key="cycle_no"
            class="history-item {{item.is_active ? 'active' : ''}}"
          >
            <view class="history-info">
              <view class="history-top">
                <text class="history-name">ç¬¬{{item.cycle_no}}ç–—ç¨‹</text>
                <text wx:if="{{item.is_active}}" class="history-badge">å½“å‰</text>
              </view>
              <text class="history-date">{{item.start_date}} Â· {{item.length_days}}å¤©</text>
              <text wx:if="{{item.current_day && item.is_active}}" class="history-day">Day {{item.current_day}}</text>
            </view>
            <view
              wx:if="{{!item.is_active}}"
              class="history-action"
              data-no="{{item.cycle_no}}"
              bindtap="switchToCycle"
            >
              <text class="history-action-text">åˆ‡æ¢</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å®¶åº­ä¿¡æ¯ -->
      <view class="card">
        <text class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶åº­</text>
        <view class="info-row">
          <text class="info-label">å®¶åº­åç§°</text>
          <text class="info-value">{{familyName}}</text>
        </view>
        <view class="info-row" bindtap="copyInviteCode">
          <text class="info-label">é‚€è¯·ç </text>
          <text class="info-value invite-code">{{inviteCode}} ğŸ“‹</text>
        </view>
      </view>

      <!-- å¿«æ·å…¥å£ï¼ˆå®¶å±ï¼‰ -->
      <view class="card" wx:if="{{!isPatient}}">
        <view class="menu-item" bindtap="goSummary">
          <text>ğŸ“‹ å°±è¯Šæ‘˜è¦</text>
          <text class="menu-arrow">â€º</text>
        </view>
      </view>

      <!-- é€€å‡º -->
      <button class="btn-logout" bindtap="onLogout">é€€å‡ºç™»å½•</button>
    </view>
</view>
