<!-- pages/trend/trend.wxml - ä¿®å¤ç‰ˆï¼šæŠ˜çº¿å›¾ + ç–—ç¨‹å¯¹æ¯” -->
<view class="trend-page">
  <view wx:if="{{loading}}" class="loading-center">åŠ è½½ä¸­...</view>

  <!-- â•â•â•â• æ‚£è€…ï¼šæ—¥å†è§†å›¾ â•â•â•â• -->
  <view wx:elif="{{isPatient}}">
    <view class="cal-header">
      <text class="cal-month">{{calMonth}}</text>
      <text class="cal-streak" wx:if="{{streak > 0}}">ğŸ”¥ è¿ç»­è®°å½•{{streak}}å¤©</text>
    </view>

    <view class="card cal-card">
      <view class="cal-weekdays">
        <text wx:for="{{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']}}" wx:key="index" class="cal-weekday">{{item}}</text>
      </view>

      <view class="cal-grid">
        <view
          wx:for="{{calendarDays}}" wx:key="index"
          class="cal-day {{item.empty ? 'empty' : ''}} {{item.isToday ? 'today' : ''}} {{item.hasLog ? 'logged' : ''}}"
        >
          <block wx:if="{{!item.empty}}">
            <text class="cal-day-num">{{item.day}}</text>
            <text class="cal-day-emoji" wx:if="{{item.emoji}}">{{item.emoji}}</text>
            <text class="cal-day-cycle" wx:if="{{item.cycleDay}}">D{{item.cycleDay}}</text>
          </block>
        </view>
      </view>
    </view>

    <view class="legend">
      <text class="legend-item">ğŸ˜Š çŠ¶æ€å¥½</text>
      <text class="legend-item">ğŸ˜ ä¸€èˆ¬</text>
      <text class="legend-item">ğŸ˜” è¾ƒè¾›è‹¦</text>
    </view>
  </view>

  <!-- â•â•â•â• å®¶å±ï¼šè¶‹åŠ¿æŠ˜çº¿å›¾ â•â•â•â• -->
  <view wx:else>
    <!-- æ ‡é¢˜ -->
    <view class="trend-header-row">
      <view>
        <text class="trend-title">ç¬¬{{cycleNo}}ç–—ç¨‹è¶‹åŠ¿</text>
        <text class="trend-subtitle" wx:if="{{cycleDay > 0}}">Day {{cycleDay}}</text>
      </view>
      <view class="compare-toggle" bindtap="toggleCompare">
        <text class="compare-toggle-text">{{showCompare ? 'å…³é—­å¯¹æ¯”' : 'ğŸ“Š å¯¹æ¯”'}}</text>
      </view>
    </view>

    <!-- ç–—ç¨‹å¯¹æ¯”é€‰æ‹©å™¨ -->
    <view wx:if="{{showCompare}}" class="compare-selector">
      <text class="compare-hint">é€‰æ‹©å¯¹æ¯”çš„ç–—ç¨‹ï¼š</text>
      <view class="compare-pills">
        <view
          wx:for="{{allCycles}}" wx:key="cycle_no"
          wx:if="{{item.cycle_no !== cycleNo}}"
          class="compare-pill {{compareNo === item.cycle_no ? 'active' : ''}}"
          data-no="{{item.cycle_no}}"
          bindtap="selectCompareCycle"
        >
          <text>ç¬¬{{item.cycle_no}}ç–—ç¨‹</text>
        </view>
        <view wx:if="{{allCycles.length <= 1}}" class="compare-empty">
          <text>æš‚æ— å…¶ä»–ç–—ç¨‹å¯å¯¹æ¯”</text>
        </view>
      </view>
    </view>

    <!-- æŒ‡æ ‡åˆ‡æ¢ -->
    <view class="metric-tabs">
      <view
        wx:for="{{metrics}}" wx:key="id"
        class="metric-tab {{activeMetric === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="switchMetric"
        style="{{activeMetric === item.id ? '--tab-color: ' + item.color : ''}}"
      >
        <text>{{item.label}}</text>
      </view>
    </view>

    <!-- æŠ˜çº¿å›¾ Canvas -->
    <view class="card chart-card">
      <view wx:if="{{trendData.length === 0}}" class="empty-hint">æš‚æ— æ•°æ®ï¼Œå¼€å§‹è®°å½•åä¼šæ˜¾ç¤ºè¶‹åŠ¿å›¾</view>
      <view wx:else class="chart-wrapper">
        <canvas type="2d" id="trendCanvas" class="trend-canvas"></canvas>
        <!-- å›¾ä¾‹ -->
        <view class="chart-legend" wx:if="{{compareNo > 0}}">
          <view class="legend-line">
            <view class="legend-line-solid" style="background: {{metrics[0].color}};"></view>
            <text>ç¬¬{{cycleNo}}ç–—ç¨‹ï¼ˆå½“å‰ï¼‰</text>
          </view>
          <view class="legend-line">
            <view class="legend-line-dashed"></view>
            <text>ç¬¬{{compareNo}}ç–—ç¨‹</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ•°æ®è¡¨æ ¼ï¼ˆè¡¥å……ï¼‰ -->
    <view class="card" wx:if="{{trendData.length > 0}}">
      <text class="section-title">ğŸ“‹ æ•°æ®æ˜ç»†</text>
      <view class="trend-table">
        <view class="trend-row trend-table-header">
          <text class="trend-cell">Day</text>
          <text class="trend-cell">ä½“åŠ›</text>
          <text class="trend-cell">æ¶å¿ƒ</text>
          <text class="trend-cell">æ’ä¾¿</text>
          <text class="trend-cell">å‘çƒ­</text>
        </view>
        <view wx:for="{{trendData}}" wx:key="cycle_day" class="trend-row">
          <text class="trend-cell day-cell">D{{item.cycle_day}}</text>
          <text class="trend-cell">{{item.energy != null ? item.energy : '-'}}</text>
          <text class="trend-cell">{{item.nausea != null ? item.nausea : '-'}}</text>
          <text class="trend-cell">{{item.stool_count != null ? item.stool_count : '-'}}</text>
          <text class="trend-cell {{item.fever ? 'danger' : ''}}">{{item.fever ? 'ğŸŒ¡ï¸' : 'â€”'}}</text>
        </view>
      </view>
    </view>

    <button class="btn-primary summary-btn" bindtap="goSummary">ğŸ“‹ æŸ¥çœ‹å°±è¯Šæ‘˜è¦</button>
  </view>
</view>
